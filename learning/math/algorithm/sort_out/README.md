## 外部排序 
外部排序指的是大文件的排序，即待排序的记录存储在外存储器上，待排序的文件无法一次装入内存，需要在内存和外部存储器之间进行多次数据交换，以达到排序整个文件的目的。
- 内存访问速度大约是磁盘的25万倍

一般来说外排序分为两个步骤：预处理和合并排序。首先，根据可用内存的大小，将外存上含有n个纪录的文件分成若干长度为t的子文件（或段）；其次，利用内部排序的方法，对每个子文件的t个纪录进行内部排序。这些经过排序的子文件（段）通常称为顺串(run)，顺串生成后即将其写入外存。这样在外存上就得到了m个顺串（m=[n/t]）。最后，对这些顺串进行归并，使顺串的长度逐渐增大，直到所有的待排序的几率成为一个顺串为止。
### 选择初始顺串
预处理阶段最重要的事情就是选择初始顺串。通常使用的方法为置换选择排序，它是堆排序的一种变形，实现思路同STL的partial_sort。步骤如下：
（1）初始化堆
从磁盘读入M个记录放到数组RAM中；
设置堆末尾标准LAST=M-1；
建立最小值堆。
（2）重复以下步骤直到堆为空
把具有最小关键码值的记录Min也就是根节点送到输出缓冲区；
设R是输入缓冲区中的下一条记录，如果R的关键码大于刚刚输出的关键码值Min，则把R放到根节点，否则使用数组中LAST位置的记录代替根节点，并将刚才的R放入到LAST所在位置，LAST=LAST-1；
（3）重新排列堆，筛出根节点。
如果堆的大小是M,一个顺串的最小长度就是M个记录，因为至少原来在堆中的那些记录将成为顺串的一部分，如果输入时逆序的，那么顺串的长度只能是M，最好情况输入是正序的，有可能一次性就能把整个文件生成一个顺串，由此可见生成顺串的长度是大小不一的，但是每个顺串却是有序的，利用扫雪机模型能够得到平均顺串的长度为2M。
外部排序最常用的算法是多路归并排序，即将原文件分解成多个能够一次性装入内存的部分，分别把每一部分调入内存完成排序。然后，对已经排序的子文件进行归并排序。

### 合并排序
1） 二路合并排序
二路合并是最简单的合并方法，合并的实现与内排序中的二路并归并无本质区别，下面通过具体例子，分析二路合并外部排序的过程。
有一个含有9000个纪录的文件需要排序（基于关键字）。假定系统仅能提供容纳1800个纪录的内存。文件在外存（如磁盘）上分块存储，每块600个纪录。外部排序的过程分为生成初始顺串和对顺串进行归并排序两个阶段。在生成初始顺串阶段，每次读入1800个纪录（即3段）待内存，采用内排序依次生成顺串依次写入外存储器中。
顺串生成后，就开一开始对顺串进行归并。首先将内存等分成3个缓冲区，和，每个缓冲区可容纳600个纪录，其中和为输入缓冲区，为输出缓冲区，每次从外存读入待归并的块到和，进行内部归并，归并后的结果送入，中的几率写满时再将其写入外存。若（或）中的纪录为空，则将待归并顺串中的后续块读入和（或）中进行归并，直到待归并的两个顺串都已归并为止。重复上述的归并方法，由含有3块龚1800个纪录的顺串经二路归并的一边归并后生成含有6块龚3600个纪录的顺串，再经过第二遍……第s遍（s=[]，m为初始顺串的个数），生成含有所有记录的顺串，从而完成了二路归并外部排序。
对文件进行外部排序的过程中，因为对外存的读写操作所用的操作的时间远远超过在内存中产生顺串和合并所需的时间，所以常用对外存的读写操作所用的时间作为外部排序的主要时间开销。分析一下上述二路归并排序的对外存的读写时间。初始时生成5个顺串的读写次数为30次(每块的读写次数为2次)，完成第一遍至第三遍归并的读写次数分别为24次、24次和30次，因此总的读写次数为108次。
类似地，可得到二路、三路……多路合并方法。
（2） 多路替代选择合并排序
采用多路合并技术，可以减少合并遍数，从而减少块读写次数，加快排序速度。但路数的多少依赖于内存容量的限制。此外，多路合并排序的快慢还依赖于内部归并算法的快慢。
设文件有n个纪录，m个初始顺串，采用k路合并方法，那么合并阶段将进行遍合并。k路合并的基本操作是从k个顺换的第一个纪录中选出最小纪录（即关键字最小的纪录），把它从输入缓冲区移入输出缓冲区。若采用直接选择方式选择最小元，需要k-1次比较，遍合并共需n(k-1)=次比较。由于随k的增长而增长，则内部归并时间亦随k的增大而增大，这将抵消由于增大k而减少外存信息读写时间所得的效果。若在k个纪录中采用树形选择方式选择最小元，则选择输出一个最小元之后，只需从某叶到根的路径上重新调整选择树，即可选择下一个最小元。重新构造选择书仅用O()次比较，于是内部合并时间O(n)=O(),它与k无关，不再随k的增大而增大。
常见的有基于“败者树”的多路替代选择合并排序方法。

******

外归并排序法并不是唯一的外排序算法。另外还有外分配排序，其原理类似于内排序中的桶排序。在归并排序和桶排序之间存在数学上的某种对偶性。此外还有一些不耗费附加磁盘空间的原地排序算法。

***

计算机科学家吉姆·格雷的SortBenchmark网站用不同的硬件、软件环境测试了实现方法不同的多种外排序算法的效率。效率较高的算法具有以下的特征：

    并行计算
        用多个磁盘驱动器并行处理数据，可以加速顺序磁盘读写。
        在计算机上使用多线程，可在多核心的计算机上得到优化。
        使用异步输入输出，可以同时排序和归并，同时读写。
        使用多台计算机用高速网络连接，分担计算任务。
    提高硬件速度
        增大内存，减小磁盘读写次数，减小归并次数。
        使用快速的外存设备，比如15000 RPM的硬盘或固态硬盘。
        使用性能更优良个各种设备，比如使用多核心CPU和延迟时间更短的内存。
    提高软件速度
        对于某些特殊数据，在第一阶段的排序中使用基数排序。
        压缩输入输出文件和临时文件。
